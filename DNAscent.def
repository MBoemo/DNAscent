Bootstrap: docker
From: nvidia/cuda:11.1.1-cudnn8-devel-ubuntu18.04

%labels
    Version v4.0.3

%help
    DNAscent is software for detecting regions of BrdU and EdU incorporation in Oxford Nanopore reads. 
    Source: https://github.com/MBoemo/DNAscent
    Documentation: https://dnascent.readthedocs.io/en/latest/?badge=latest
    Web: https://www.boemogroup.org/
    Please submit any bugs to https://github.com/MBoemo/DNAscent/issues.

%post

    # Install system packages
    apt-get update && apt-get install -y \
        lzma-dev \
        build-essential \
        liblzma-dev \
        libbz2-dev \
        libbsd-dev \
        wget \
        git \
        gcc-8 \
        g++-8 \
        zlib1g-dev \
        libncurses5-dev \
        libgdbm-dev \
        libnss3-dev \
        libssl-dev \
        libreadline-dev \
        libffi-dev \
        libsqlite3-dev \
        python3 \
        python3-pip \
        libboost-all-dev
  
    # get and build CMake
    wget https://github.com/Kitware/CMake/releases/download/v3.20.0/cmake-3.20.0.tar.gz
    tar -zvxf cmake-3.20.0.tar.gz
    cd cmake-3.20.0
    ./bootstrap
    make -j8
    apt-get install -y checkinstall
    checkinstall --pkgname=cmake --pkgversion="3.20-custom" --default
    hash -r
    cmake --version

    # Build python 3.9
    mkdir -p /opt/python3.9
    wget https://www.python.org/ftp/python/3.9.17/Python-3.9.17.tgz
    tar -xf Python-3.9.17.tgz
    cd Python-3.9.17
    ./configure --prefix=/opt/python3.9 --enable-optimizations
    make -j $(nproc)
    make altinstall
    /opt/python3.9/bin/python3.9 -m ensurepip --upgrade
    apt-get clean
    rm -rf /var/lib/apt/lists/* Python-3.9.17 Python-3.9.17.tgz
    cd /

    # Link python3 to python3.9 and link pip to pip3.9
    ln -sf /opt/python3.9/bin/python3.9 /usr/bin/python3
    ln -sf /opt/python3.9/bin/pip3.9 /usr/bin/pip3

    # Install conan
    pip3 install "conan<2" build;
    export PATH=$PATH:/opt/python3.9/bin
    
    # Set GCC-8 as the default GCC version
    update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-8 100 \
                        --slave /usr/bin/g++ g++ /usr/bin/g++-8
    update-alternatives --set gcc /usr/bin/gcc-8

    # Create a default conan profile that uses GCC 8
    conan profile new default --detect
    conan profile update settings.compiler=gcc default
    conan profile update settings.compiler.version=8 default
    conan profile update settings.compiler.libcxx=libstdc++11 default    

    # Clone and compile DNAscent
    mkdir -p /app
    cd app
    git clone --recursive https://github.com/MBoemo/DNAscent.git
    cd DNAscent
    make
    
    # Install vbz plugin
    cd /
    mkdir -p /plugin
    cd plugin
    wget https://github.com/nanoporetech/vbz_compression/releases/download/v1.0.1/ont-vbz-hdf-plugin-1.0.1-Linux-x86_64.tar.gz
    tar -xf ont-vbz-hdf-plugin-1.0.1-Linux-x86_64.tar.gz 
 
   
%environment

    # cuda paths
    export CUDA_HOME=/usr/local/cuda
    export CPATH=/usr/local/cuda/include:$CPATH
    export CUDA_PATH=/usr/local/cuda
    export LIBRARY_PATH=/usr/local/cuda/lib64:$LIBRARY_PATH
    export LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH
    export PATH=/usr/local/cuda/bin:$PATH
    
    # vbz plugin path
    export HDF5_PLUGIN_PATH=/plugin/ont-vbz-hdf-plugin-1.0.1-Linux/usr/local/hdf5/lib/plugin

%runscript
    exec /app/DNAscent/bin/DNAscent "$@"
